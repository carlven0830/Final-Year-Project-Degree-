from flask import Flask, request, jsonify, render_template
import joblib
import traceback
import pandas as pd
import numpy as np
import json
import sys

application = Flask(__name__, static_url_path='/static', static_folder='static')

@application.route('/')
def home():
    return render_template('index.html')

@application.route('/prediction', methods=['POST'])
#define function
def predict():
    if request.method == 'POST':
        try:
            data = request.form['data']
            input_dict = json.loads(data)
            input_df = pd.DataFrame.from_dict(input_dict)
            predictions = lgb_model.predict(input_df)

            result = {'predictions': str(predictions)}
            
            if predictions == 0:
                result['message'] = 'Predicted Malware: APT1'
            elif predictions == 1:
                result['message'] = 'Predicted Malware: Crypto'
            elif predictions == 2:
                result['message'] = 'Predicted Malware: Locker'
            elif predictions == 3:
                result['message'] = 'Predicted Malware: Zeus'
            elif predictions == 4:
                result['message'] = 'Predicted Malware: Shadowbrokers'
            else:
                result['message'] = 'Unknown Malware'
                
            return jsonify(result)
        
        except Exception as e:
            print(str(e))
            return jsonify({'error': str(e)})
    else:
        return jsonify({'error': 'Invalid request method'})


if __name__ == '__main__':
    # Attempt to read the port from the command-line argument
    try:
        port = int(sys.argv[1])
    except (IndexError, ValueError):
        # If no valid port is provided, use default port 3000
        port = 3000

    # Attempt to load the model
    try:
        lgb_model = joblib.load("lgbModel.pkl")
        print('Model loaded')
    except Exception:
        # If the model fails to load, print an error message and exit the program
        print('Failed to load model')
        sys.exit(1)

    # Start the Flask application on the specified port
    application.run(port=port, debug=True)
